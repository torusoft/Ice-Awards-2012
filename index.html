<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="initial-scale=1.0, user-scalable=no"/>
<meta http-equiv="content-type" content="text/html; charset=UTF-8"/>
<title>Instagram</title>
<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.6.2/jquery.min.js"></script> 
<script type="text/javascript" src="jquery.transit.min.js"></script> 
<script type="text/javascript" src="jquery.slideshowify.min.js"></script> 
<script type="text/javascript" src="moment.min.js"></script> 

<style>
html, body { height: 720px; margin: 0; padding: 0; background: #000; width: 1280px; border: 1px solid red; position: relative; top: 0px; left: 0px;}

.instagram-container {
	position: relative; 
	width: 486px; 
	height: 252px;
	border: 1px solid #000;
	z-index: 10;
}


.twitter-feed-area{position: absolute; bottom: 0px; right: 0px; width: 360px; height: 585px; background: #000; background: gray;}
.twitter-feed{width: 324px; height: 376px; background: url('twitter-feed-background.png') no-repeat; margin: 154px 18px 0px 18px;}
.twitter-feed-area A.footer{display:block; width: 225px; height: 36px; background: url('twitter-bubble.png') no-repeat; float: right; margin: 8px 18px 18px 18px; color: red; font-size: 18px; font-family: Helvetica, sans-serif; font-weight: bold; text-indent: 10px; padding: 2px;}
</style>
<script type="text/javascript">
<!--

var offset = "";
var twitter_offset = "";

$(document).ready(function(){

	var photo_stack = [];
	var tweet_stack = [];

	function getNewPhotos(){
		console.log("calling " + "https://api.instagram.com/v1/tags/halifax/media/recent?min_id=" + offset + "&callback=?")
		$.getJSON("https://api.instagram.com/v1/tags/halifax/media/recent?min_id=" + offset + "&callback=?",{access_token:'3794301.f59def8.e08bcd8b10614074882b2d1b787e2b6f'}, function(data){
			if(data.meta.code == 200) {

				var photos = data.data;

				if(photos.length > 0) {

					offset = data.pagination.min_tag_id;
					photo_stack = photos.concat(photo_stack);

					for (var key in photos){
						var photo = photos[key];
						var tmp = $('<img id="' + photo.id + '" src="' + photo.images.standard_resolution.url + '">');
						$("#panel").append(tmp);

					}
					$(".instagram-container").empty();
					$('#panel img').slideshowify({ parentEl:'.instagram-container' });
				}
				else{
					console.log('empty');
				}
				
			}else{
				console.log(data.meta.error_message);
			}
			
			console.log(photo_stack);
	
		});
	};


	var tweet_cursor = 0;

	function getNewTweets(){
		console.log("calling " + "http://search.twitter.com/search.json?q=halifax=5&rpp=50&since_id="+twitter_offset+"&include_entities=1");
		$.ajax("http://search.twitter.com/search.json?q=halifax&rpp=50&since_id="+twitter_offset+"&include_entities=1", {
			crossDomain: true,
			dataType: "jsonp",
			success: function(data){

				tweet_stack = data.results.concat(tweet_stack);
				tweet_stack.slice(0,29);
				console.log(tweet_stack);
				console.log(data.results[0]);
				if(data.results.length > 0)
					twitter_offset = data.results[0].id;
			}
		});
	};

	function displayTweets(){

		console.log(tweet_cursor);
		console.log(tweet_stack);

		$('.twitter-feed UL').empty();

		if(tweet_cursor >= 29) tweet_cursor = 0;

		for(var i=tweet_cursor, ceiling=tweet_cursor+5; ((i<ceiling) && (tweet_cursor < tweet_stack.length)); i++){
			console.log(i);
			var item = tweet_stack[i]
			var text = item.text;
	 		var exp = /(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/i;
	   		text = text.replace(exp,"<a href='$1' target='_blank'>$1</a>");
	   		text = text.replace(/(^|\s)@(\w+)/g, "$1@<a href=\"http://www.twitter.com/$2\" target='_blank'>$2</a>");
	  		text = text.replace(/(^|\s)#(\w+)/g, "$1#<a href=\"http://search.twitter.com/search?q=%23$2\" target='_blank'>$2</a>");
			
		    var created = moment(tweet_stack[i].created_at).fromNow();
			text = text+"<br /><span>"+created+"</span>";
			$("<li><b>" + item.from_user_name + "</b> " + text + "</li>").appendTo(".twitter-feed UL");
			tweet_cursor++;
		}
	}

	var poll_token_instagram = setInterval(getNewPhotos, 20000);
	var poll_token_twitter_fetch = setInterval(getNewTweets, 30000);
	var poll_token_twitter_display = setInterval(displayTweets, 10000);

	getNewPhotos();
	getNewTweets();

});
//-->
</script>
</head>
<body>

<div class="instagram-container">
</div>

<div id="panel"></div>



<div class="twitter-feed-area">
	<div class="twitter-feed"><ul></ul></div>
	<a class="footer">#IceAwards2012</a>
</div>
</body>
</html>